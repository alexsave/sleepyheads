/*
We get something like
[{"endDate": "2022-10-05T00:34:45.351-0700", "id": "E39441FF-986E-4CEC-B4F8-6FB5DCDBAA91", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-04T22:39:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T00:35:45.351-0700", "id": "7D623633-5770-45DD-8B0F-32D43FDE5F27", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T00:34:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T00:38:45.351-0700", "id": "AB98FC10-149C-4A2C-97B8-4A0B786D8999", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T00:35:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T00:40:15.351-0700", "id": "93B40A31-A039-4842-BBC4-C2F19044CB86", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T00:38:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T01:15:45.351-0700", "id": "F74C1EA9-F31D-45E3-9556-8C80933452FE", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T00:40:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T01:17:45.351-0700", "id": "CE9ADF26-AB6C-4F4C-9917-BA070C149781", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T01:15:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T02:18:15.351-0700", "id": "A6168DCD-10CC-4F9A-8190-ACC95C1A365D", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T01:17:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T02:18:45.351-0700", "id": "C5C90078-A32E-4E1F-9786-3FB45C02FAC7", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T02:18:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T04:28:15.351-0700", "id": "234BBEB3-4AE8-49D2-82F9-16C4868F2CE5", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T02:18:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T04:29:45.351-0700", "id": "5C3527CA-0219-4E42-BEF3-CE7ADD7B9FE4", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T04:28:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T05:46:15.351-0700", "id": "3744E63C-CE90-442F-96AD-408F945DBA72", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T04:29:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T05:46:45.351-0700", "id": "FB8CA620-10F4-404D-869E-36C04866C186", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T05:46:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T05:55:45.351-0700", "id": "646BDB93-454B-4044-8691-9C7E9302ED8F", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T05:46:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T05:57:15.351-0700", "id": "D62E0DBE-F50A-45FC-B5FE-F206BD17C344", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T05:55:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:32:15.351-0700", "id": "8B0D031E-9BD6-42D1-B2BA-547F3746C7EF", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T05:57:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:33:15.351-0700", "id": "6A4C166B-6E4F-445D-B37F-5974BB5565F0", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T06:32:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:34:15.351-0700", "id": "4840E68B-B401-47F9-A370-8EA04FA9A11D", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T06:33:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:46:45.351-0700", "id": "F5B269F7-17CA-4B3B-9B84-47A4E828C84F", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T06:34:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:51:15.351-0700", "id": "CCD05D48-6930-4976-9B82-73B6CAC7F1D6", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T06:46:45.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:53:15.351-0700", "id": "686A6E5C-3465-4FD0-BB36-571C95BB2E4D", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T06:51:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T06:58:15.351-0700", "id": "DF72B703-E647-4D64-AADB-F2424E74CA66", "sourceId": "com.apple.health.EF660227-B627-4392-A3AA-B58791C806F1", "sourceName": "Alex’s Apple Watch", "startDate": "2022-10-05T06:53:15.351-0700", "value": "UNKNOWN"}, {"endDate": "2022-10-05T07:00:39.830-0700", "id": "2DDD19F6-B498-4004-9198-C5B823907940", "sourceId": "com.apple.health.5FA8CB53-7880-49AF-B0DE-6954E180CEAD", "sourceName": "Alex’s iPhone (2)", "startDate": "2022-10-04T22:27:40.000-0700", "value": "INBED"}]
I'd like to split it up a bit
First off, by sleep "session"


So if we do descending, we have a big INBED followed by a bunch of intervals within it

 */

import { SleepSampleType } from '../models';

export const processSleep = raw => {
    let groupings = [];

    let currentGroup = {samples: []};

    // Finding: INBED isn't the most accurate, as there might be samples that extend "through" the inbed endDate
    // For instance:

    //LOG  {"endDate": "2022-10-15T08:08:02.797-0700", "startDate": "2022-10-15T07:48:32.797-0700", "value": "CORE"}
    //LOG  {"endDate": "2022-10-15T07:48:32.797-0700", "startDate": "2022-10-15T07:44:32.797-0700", "value": "AWAKE"}
    //LOG  {"endDate": "2022-10-15T07:44:32.797-0700", "startDate": "2022-10-15T06:45:32.797-0700", "value": "CORE"}
    //LOG  {"endDate": "2022-10-15T07:00:00.640-0700", "startDate": "2022-10-14T23:49:58.000-0700", "value": "INBED"}
    //LOG  {"endDate": "2022-10-15T06:45:32.797-0700", "startDate": "2022-10-15T06:45:02.797-0700", "value": "AWAKE"}
    // so it's now sorted by startDate ascending

    // another finding: older data is not super compatible.
    // there is only INBED, then a bunch of ASLEEP. There is no AWAKE value
    // for newer types of data, there is awake 10-11, core 11-12, awake 12-1, core 1-5, and so on
    // for older, there is alseep 10-11, alseep 12-3, asleep 4-5

    raw.forEach(sample => {
        if (sample.value === SleepSampleType.INBED || (sample.value !== SleepSampleType.ASLEEP && currentGroup.samples.length && sample.startDate !== currentGroup.samples[currentGroup.samples.length-1].endDate)) {

            // signifies new sleep
            groupings.push(currentGroup);
            currentGroup = {
                bedStart: sample.startDate,
                bedEnd: sample.endDate,
                samples:[]
            };
        } else {
            if (new Date(sample.startDate) < new Date(currentGroup.bedStart)){
                console.log('impossible scenario')
            }

            currentGroup.samples.push(sample);
            if (!currentGroup.bedEnd || sample.endDate > currentGroup.bedEnd)
                  currentGroup.bedEnd = sample.endDate;
            if (!currentGroup.bedStart || sample.startDate < currentGroup.bedStart)
                currentGroup.bedStart = sample.startDate;
        }
    });

    groupings.push(currentGroup);

    // somehow, it's possible that a gropuing doesn't have a start date at this poitn
    /*groupings.forEach(g => {
        console.log(g);
    })*/

    groupings.map(group => {
        const start = new Date(group.bedStart);
        group.samples = group.samples.map(sample => ({
            startOffset: (new Date(sample.startDate) - start) / 1000,
            endOffset: (new Date(sample.endDate) - start) / 1000,
            type: sample.value
        }));
        // should this be end - start or total asleep time? both?
        group.duration = (new Date(group.bedEnd) - new Date(group.bedStart)) / 1000;

        return group;
    });

    groupings = groupings.filter(g => g.samples.length);

    //return [];
    //return groupings.reverse();
    return groupings; //please dont fuck everything up
};
